<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共有URLテストツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold mb-4">
                <i class="fas fa-share-alt mr-2"></i>
                共有URL生成テストツール
            </h1>
            
            <div class="mb-6 p-4 bg-blue-50 rounded">
                <h2 class="text-lg font-semibold mb-2">このツールでできること</h2>
                <ul class="list-disc list-inside space-y-1">
                    <li>現在のデータを確認</li>
                    <li>共有URLを生成</li>
                    <li>生成したURLをテスト</li>
                </ul>
            </div>

            <!-- データ確認セクション -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">
                    <i class="fas fa-database mr-2"></i>
                    現在のデータ
                </h3>
                <div id="currentData" class="p-3 bg-gray-50 rounded text-sm"></div>
            </div>

            <!-- 共有URL生成セクション -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">
                    <i class="fas fa-link mr-2"></i>
                    共有URL生成
                </h3>
                
                <button onclick="generateShareUrl()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-3">
                    共有URLを生成
                </button>

                <div id="shareUrlSection" class="hidden">
                    <div class="p-3 bg-green-50 border border-green-200 rounded mb-3">
                        <p class="text-sm text-green-800 mb-2">✅ 共有URLが生成されました！</p>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="shareUrlInput" readonly class="flex-1 p-2 border rounded text-sm">
                            <button onclick="copyUrl()" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800 mb-2">⚠️ URLが長すぎる場合の対処法：</p>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li>必要最小限のデータで共有</li>
                            <li>URL短縮サービスを使用</li>
                            <li>JSONファイルとして共有</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- デバッグ情報 -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">
                    <i class="fas fa-bug mr-2"></i>
                    デバッグ情報
                </h3>
                <div id="debugInfo" class="p-3 bg-gray-50 rounded text-xs font-mono"></div>
            </div>

            <!-- メインアプリへのリンク -->
            <div class="text-center">
                <a href="./index.html" class="inline-block bg-green-500 text-white px-6 py-3 rounded hover:bg-green-600">
                    <i class="fas fa-home mr-2"></i>
                    メインアプリに戻る
                </a>
            </div>
        </div>
    </div>

    <script>
        // ページ読み込み時にデータを確認
        document.addEventListener('DOMContentLoaded', function() {
            checkCurrentData();
        });

        function checkCurrentData() {
            const subjects = localStorage.getItem('studySubjects');
            const progress = localStorage.getItem('studyProgress');
            
            const dataDiv = document.getElementById('currentData');
            const debugDiv = document.getElementById('debugInfo');
            
            if (!subjects && !progress) {
                dataDiv.innerHTML = `
                    <p class="text-red-600">❌ データが見つかりません</p>
                    <p class="mt-2">まずメインアプリでデータを追加してください。</p>
                `;
                debugDiv.innerHTML = 'localStorage is empty';
                return;
            }
            
            try {
                const subjectsData = subjects ? JSON.parse(subjects) : [];
                const progressData = progress ? JSON.parse(progress) : [];
                
                dataDiv.innerHTML = `
                    <p>✅ 科目数: ${subjectsData.length}件</p>
                    <p>✅ 進捗記録: ${progressData.length}件</p>
                    <p class="mt-2 text-xs">データサイズ: ${(subjects?.length || 0) + (progress?.length || 0)} bytes</p>
                `;
                
                debugDiv.innerHTML = `
                    Subjects: ${subjectsData.length} items<br>
                    Progress: ${progressData.length} items<br>
                    Total size: ${new Blob([subjects || '', progress || '']).size} bytes
                `;
                
            } catch (error) {
                dataDiv.innerHTML = `<p class="text-red-600">❌ データの読み込みエラー: ${error.message}</p>`;
                debugDiv.innerHTML = `Error: ${error.message}`;
            }
        }

        function generateShareUrl() {
            const subjects = localStorage.getItem('studySubjects');
            const progress = localStorage.getItem('studyProgress');
            
            if (!subjects && !progress) {
                alert('共有するデータがありません。');
                return;
            }
            
            try {
                const shareData = {
                    subjects: subjects ? JSON.parse(subjects) : [],
                    dailyProgress: progress ? JSON.parse(progress) : [],
                    timestamp: new Date().toISOString()
                };
                
                // Base64エンコード
                const encodedData = btoa(unescape(encodeURIComponent(JSON.stringify(shareData))));
                
                // 現在のURLを取得
                const baseUrl = window.location.origin + window.location.pathname.replace('share-url-test.html', 'index.html');
                const shareUrl = `${baseUrl}?data=${encodedData}`;
                
                // URL表示
                document.getElementById('shareUrlSection').classList.remove('hidden');
                document.getElementById('shareUrlInput').value = shareUrl;
                
                // デバッグ情報更新
                document.getElementById('debugInfo').innerHTML += `<br><br>
                    Share URL generated:<br>
                    - Base URL: ${baseUrl}<br>
                    - Data size: ${encodedData.length} chars<br>
                    - Total URL length: ${shareUrl.length} chars<br>
                    ${shareUrl.length > 2000 ? '<span class="text-red-600">⚠️ URL is too long!</span>' : '<span class="text-green-600">✅ URL length is OK</span>'}
                `;
                
                // 自動でクリップボードにコピー
                copyUrl();
                
            } catch (error) {
                alert('エラー: ' + error.message);
                document.getElementById('debugInfo').innerHTML += `<br>Error: ${error.message}`;
            }
        }

        function copyUrl() {
            const input = document.getElementById('shareUrlInput');
            
            // 古いブラウザ向けのフォールバック
            if (!navigator.clipboard) {
                input.select();
                document.execCommand('copy');
                alert('URLをコピーしました！');
                return;
            }
            
            // モダンブラウザ
            navigator.clipboard.writeText(input.value).then(() => {
                alert('URLをコピーしました！');
            }).catch(err => {
                alert('コピーに失敗しました: ' + err);
            });
        }
    </script>
</body>
</html>