<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç¿’é€²æ—ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* å…±æœ‰ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .shared-mode-disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .shared-mode-hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-graduation-cap mr-2"></i>
                    å­¦ç¿’é€²æ—ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </h1>
                <div class="flex items-center space-x-4">
                    <!-- å…±æœ‰ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
                    <div id="sharedModeIndicator" class="hidden bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-eye mr-1"></i>
                        é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰
                    </div>
                    
                    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³ -->
                    <button id="dataManageBtn" onclick="openDataModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                        <i class="fas fa-database mr-2"></i>
                        ãƒ‡ãƒ¼ã‚¿ç®¡ç†
                    </button>
                </div>
            </div>
        </div>

        <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">ä»Šæ—¥ã®é€²æ—</p>
                        <p class="text-2xl font-bold text-blue-600" id="todayProgress">0å•</p>
                    </div>
                    <i class="fas fa-calendar-day text-3xl text-blue-200"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">ä»Šé€±ã®é€²æ—</p>
                        <p class="text-2xl font-bold text-green-600" id="weekProgress">0å•</p>
                    </div>
                    <i class="fas fa-calendar-week text-3xl text-green-200"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">ç·é€²æ—</p>
                        <p class="text-2xl font-bold text-purple-600" id="totalProgress">0å•</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-purple-200"></i>
                </div>
            </div>
        </div>

        <!-- ç§‘ç›®ãƒªã‚¹ãƒˆ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">
                    <i class="fas fa-books mr-2"></i>
                    ç§‘ç›®ä¸€è¦§
                </h2>
                <div class="flex gap-2">
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <select id="filterSelect" onchange="applyFilter()" class="border rounded px-3 py-2 text-sm">
                        <option value="all">ã™ã¹ã¦è¡¨ç¤º</option>
                        <option value="incomplete">æœªå®Œäº†ã®ã¿</option>
                        <option value="complete">å®Œäº†æ¸ˆã¿</option>
                        <option value="deadline-near">æœŸé™ãŒè¿‘ã„</option>
                        <option value="deadline-over">æœŸé™åˆ‡ã‚Œ</option>
                    </select>
                    <!-- ä¸¦ã³æ›¿ãˆ -->
                    <select id="sortSelect" onchange="applySort()" class="border rounded px-3 py-2 text-sm">
                        <option value="default">æ¨å¥¨é †ï¼ˆé”æˆç‡é †ãƒ»å®Œäº†ã¯ä¸‹ï¼‰</option>
                        <option value="name">åå‰é †</option>
                        <option value="progress">é€²æ—ç‡é †ï¼ˆå®Œäº†å«ã‚€ï¼‰</option>
                        <option value="deadline">æœŸé™é †</option>
                        <option value="remaining">æ®‹ã‚Šæ•°é †</option>
                    </select>
                    <!-- å±¥æ­´ãƒœã‚¿ãƒ³ -->
                    <button onclick="openHistoryModal()" class="bg-indigo-500 text-white px-3 py-2 rounded hover:bg-indigo-600 transition text-sm">
                        <i class="fas fa-history"></i>
                    </button>
                    <button id="addSubjectBtn" onclick="openAddSubjectModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                        <i class="fas fa-plus mr-2"></i>
                        ç§‘ç›®è¿½åŠ 
                    </button>
                </div>
            </div>
            
            <div id="subjectsList" class="space-y-4">
                <!-- ç§‘ç›®ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-bar mr-2"></i>
                    æ—¥åˆ¥é€²æ—
                </h3>
                <canvas id="dailyChart"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-pie mr-2"></i>
                    ç§‘ç›®åˆ¥é”æˆç‡
                </h3>
                <canvas id="completionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ç§‘ç›®è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="addSubjectModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0" onclick="closeAddSubjectModal()"></div>
        <div class="bg-white rounded-lg p-6 w-96 relative z-10 slide-up">
            <h3 class="text-xl font-semibold mb-4">æ–°ã—ã„ç§‘ç›®ã‚’è¿½åŠ </h3>
            <form onsubmit="addSubject(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç§‘ç›®å</label>
                    <input type="text" id="subjectName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™å•é¡Œæ•°</label>
                    <input type="number" id="targetQuestions" required min="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å˜ä½</label>
                    <select id="unit" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="å•">å•</option>
                        <option value="ãƒšãƒ¼ã‚¸">ãƒšãƒ¼ã‚¸</option>
                        <option value="ç« ">ç« </option>
                        <option value="æ™‚é–“">æ™‚é–“</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æœŸé™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="date" id="deadline" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeAddSubjectModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        è¿½åŠ 
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- é€²æ—å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="historyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0" onclick="closeHistoryModal()"></div>
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl relative z-10 slide-up max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-history mr-2"></i>
                é€²æ—å±¥æ­´
            </h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ç§‘ç›®ã‚’é¸æŠ</label>
                <select id="historySubjectSelect" onchange="updateHistoryDisplay()" class="w-full border rounded px-3 py-2">
                    <option value="all">ã™ã¹ã¦ã®ç§‘ç›®</option>
                </select>
            </div>
            
            <div id="historyContent" class="space-y-2">
                <!-- å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            
            <div class="flex justify-end mt-4">
                <button onclick="closeHistoryModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="dataModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0" onclick="closeDataModal()"></div>
        <div class="bg-white rounded-lg p-6 w-96 relative z-10 slide-up">
            <h3 class="text-xl font-semibold mb-4">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            
            <div class="space-y-4">
                <!-- å…±æœ‰URLç”Ÿæˆ -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">
                        <i class="fas fa-share-alt mr-2"></i>
                        å…±æœ‰URLç”Ÿæˆ
                    </h4>
                    <p class="text-sm text-gray-600 mb-2">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’é–²è¦§å°‚ç”¨ã§å…±æœ‰ã§ãã¾ã™</p>
                    <button onclick="generateShareUrl()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mb-2">
                        å…±æœ‰URLã‚’ç”Ÿæˆ
                    </button>
                    <button onclick="openShareView()" class="w-full bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                        <i class="fas fa-external-link-alt mr-2"></i>
                        å…±æœ‰ãƒ“ãƒ¥ãƒ¼ã‚’é–‹ã
                    </button>
                    <div id="shareUrlDisplay" class="hidden mt-2 p-2 bg-gray-100 rounded text-xs break-all"></div>
                </div>
                
                <!-- ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">
                        <i class="fas fa-download mr-2"></i>
                        ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </h4>
                    <button onclick="exportData()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
                    </button>
                </div>
                
                <!-- ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">
                        <i class="fas fa-upload mr-2"></i>
                        ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </h4>
                    <input type="file" id="importFile" accept=".json" class="w-full mb-2">
                    <button onclick="importData()" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                    </button>
                </div>
                
                <!-- ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ -->
                <div class="border rounded-lg p-4 border-purple-200 mb-4">
                    <h4 class="font-medium mb-2 text-purple-600">
                        <i class="fas fa-exchange-alt mr-2"></i>
                        ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
                    </h4>
                    <a href="./data-migration.html" class="block w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-center mb-2">
                        ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«ã‚’é–‹ã
                    </a>
                    <button onclick="debugLocalStorage()" class="w-full bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-bug mr-2"></i>
                        LocalStorageãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    </button>
                </div>
                
                <!-- ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ -->
                <div class="border rounded-lg p-4 border-red-200">
                    <h4 class="font-medium mb-2 text-red-600">
                        <i class="fas fa-trash-alt mr-2"></i>
                        ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
                    </h4>
                    <button onclick="resetData()" class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                    </button>
                </div>
            </div>
            
            <div class="flex justify-end mt-4">
                <button onclick="closeDataModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let subjects = [];
        let dailyProgress = [];
        let charts = {};
        let isSharedMode = false;
        let currentFilter = 'all';
        let currentSort = 'default';

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        function initializeApp() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            
            if (sharedData) {
                // å…±æœ‰ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
                isSharedMode = true;
                try {
                    const decodedData = JSON.parse(atob(sharedData));
                    
                    // åœ§ç¸®ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                    if (decodedData.s && decodedData.p) {
                        // åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹
                        const decompressed = decompressData(decodedData);
                        subjects = decompressed.subjects || [];
                        dailyProgress = decompressed.dailyProgress || [];
                    } else {
                        // å¤ã„å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆäº’æ›æ€§ä¿æŒï¼‰
                        subjects = decodedData.subjects || [];
                        dailyProgress = decodedData.dailyProgress || [];
                    }
                    
                    // å…±æœ‰ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤ºè¨­å®š
                    document.getElementById('sharedModeIndicator').classList.remove('hidden');
                    
                    // ç·¨é›†æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–
                    disableEditingFeatures();
                    
                    showNotification('å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆé–²è¦§å°‚ç”¨ï¼‰', 'info');
                } catch (error) {
                    console.error('å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                    showNotification('å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    loadDataFromLocalStorage();
                }
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
                loadDataFromLocalStorage();
            }
            
            updateDisplay();
            
            // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤
            if (typeof Chart !== 'undefined') {
                initCharts();
            } else {
                // Chart.jsãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
                setTimeout(() => {
                    if (typeof Chart !== 'undefined') {
                        initCharts();
                    } else {
                        console.warn('Chart.js could not be loaded');
                    }
                }, 1000);
            }
        }

        // ç·¨é›†æ©Ÿèƒ½ã®ç„¡åŠ¹åŒ–
        function disableEditingFeatures() {
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const editButtons = [
                'addSubjectBtn',
                'dataManageBtn'
            ];
            
            editButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.add('shared-mode-disabled');
                    btn.disabled = true;
                }
            });
            
            // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
            const dataBtn = document.getElementById('dataManageBtn');
            if (dataBtn) {
                dataBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>é–²è¦§å°‚ç”¨';
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadDataFromLocalStorage() {
            const savedSubjects = localStorage.getItem('studySubjects');
            const savedProgress = localStorage.getItem('studyProgress');
            
            console.log('LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿...');
            
            if (savedSubjects) {
                try {
                    subjects = JSON.parse(savedSubjects);
                    console.log('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ:', subjects.length, 'ç§‘ç›®');
                } catch (e) {
                    console.error('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
                    subjects = [];
                }
            } else {
                console.log('ç§‘ç›®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                subjects = [];
            }
            
            if (savedProgress) {
                try {
                    dailyProgress = JSON.parse(savedProgress);
                    console.log('é€²æ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ:', dailyProgress.length, 'ä»¶');
                } catch (e) {
                    console.error('é€²æ—ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—:', e);
                    dailyProgress = [];
                }
            } else {
                console.log('é€²æ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                dailyProgress = [];
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®ã¿ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            if (subjects.length === 0 && dailyProgress.length === 0) {
                console.log('ãƒ‡ãƒ¼ã‚¿ãŒç©ºãªã®ã§ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º');
                subjects = [
                    {
                        id: Date.now(),
                        name: "ã‚µãƒ³ãƒ—ãƒ«ç§‘ç›®ï¼ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰",
                        target_questions: 100,
                        unit: "å•",
                        deadline: "2025-12-31",
                        order_index: 0,
                        created_at: new Date().toISOString()
                    }
                ];
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            if (!isSharedMode) {
                localStorage.setItem('studySubjects', JSON.stringify(subjects));
                localStorage.setItem('studyProgress', JSON.stringify(dailyProgress));
            }
        }

        // ç§‘ç›®è¿½åŠ 
        function addSubject(event) {
            event.preventDefault();
            
            if (isSharedMode) {
                showNotification('é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç·¨é›†ã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            const newSubject = {
                id: Date.now(),
                name: document.getElementById('subjectName').value,
                target_questions: parseInt(document.getElementById('targetQuestions').value),
                unit: document.getElementById('unit').value,
                deadline: document.getElementById('deadline').value || null,
                order_index: subjects.length,
                created_at: new Date().toISOString()
            };
            
            subjects.push(newSubject);
            saveData();
            updateDisplay();
            closeAddSubjectModal();
            showNotification('ç§‘ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }

        // é€²æ—æ›´æ–°
        function updateProgress(subjectId, increment) {
            if (isSharedMode) {
                showNotification('é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç·¨é›†ã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            let todayProgress = dailyProgress.find(p => 
                p.subject_id === subjectId && p.date === today
            );
            
            if (todayProgress) {
                todayProgress.completed_count += increment;
                if (todayProgress.completed_count < 0) {
                    todayProgress.completed_count = 0;
                }
            } else {
                if (increment > 0) {
                    dailyProgress.push({
                        id: Date.now(),
                        subject_id: subjectId,
                        date: today,
                        completed_count: increment,
                        created_at: new Date().toISOString()
                    });
                }
            }
            
            saveData();
            updateDisplay();
        }

        // ç§‘ç›®å‰Šé™¤
        function deleteSubject(subjectId) {
            if (isSharedMode) {
                showNotification('é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç·¨é›†ã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            if (confirm('ã“ã®ç§‘ç›®ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                subjects = subjects.filter(s => s.id !== subjectId);
                dailyProgress = dailyProgress.filter(p => p.subject_id !== subjectId);
                saveData();
                updateDisplay();
                showNotification('ç§‘ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            updateSubjectsList();
            updateSummary();
            updateCharts();
        }

        // ç§‘ç›®ãƒªã‚¹ãƒˆæ›´æ–°
        function updateSubjectsList() {
            const container = document.getElementById('subjectsList');
            
            let displaySubjects = [...subjects];
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            if (currentFilter !== 'all') {
                displaySubjects = displaySubjects.filter(subject => {
                    const totalCompleted = dailyProgress
                        .filter(p => p.subject_id === subject.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    const percentage = Math.min(100, Math.round((totalCompleted / subject.target_questions) * 100));
                    const isComplete = totalCompleted >= subject.target_questions;
                    
                    const deadline = new Date(subject.deadline);
                    const now = new Date();
                    const daysRemaining = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                    
                    switch (currentFilter) {
                        case 'incomplete':
                            return !isComplete;
                        case 'complete':
                            return isComplete;
                        case 'deadline-near':
                            return daysRemaining <= 7 && daysRemaining > 0;
                        case 'deadline-over':
                            return daysRemaining < 0;
                        default:
                            return true;
                    }
                });
            }
            
            // ã‚½ãƒ¼ãƒˆé©ç”¨
            if (currentSort === 'default') {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å®Œäº†æ¸ˆã¿ã¯ä¸‹ã€æœªå®Œäº†ã¯é”æˆç‡é †
                displaySubjects.sort((a, b) => {
                    const aTotal = dailyProgress.filter(p => p.subject_id === a.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    const bTotal = dailyProgress.filter(p => p.subject_id === b.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    
                    const aPercentage = Math.min(100, Math.round((aTotal / a.target_questions) * 100));
                    const bPercentage = Math.min(100, Math.round((bTotal / b.target_questions) * 100));
                    
                    // 100%ã®ç§‘ç›®ã‚’ä¸‹ã«
                    if (aPercentage === 100 && bPercentage !== 100) return 1;
                    if (aPercentage !== 100 && bPercentage === 100) return -1;
                    
                    // ä¸¡æ–¹100%ã®å ´åˆã¯åå‰é †
                    if (aPercentage === 100 && bPercentage === 100) {
                        return a.name.localeCompare(b.name);
                    }
                    
                    // ä¸¡æ–¹100%æœªæº€ã®å ´åˆã¯é”æˆç‡ãŒé«˜ã„é †
                    return bPercentage - aPercentage;
                });
            } else if (currentSort !== 'default') {
                displaySubjects.sort((a, b) => {
                    const aTotal = dailyProgress.filter(p => p.subject_id === a.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    const bTotal = dailyProgress.filter(p => p.subject_id === b.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    
                    const aPercentage = Math.min(100, Math.round((aTotal / a.target_questions) * 100));
                    const bPercentage = Math.min(100, Math.round((bTotal / b.target_questions) * 100));
                    
                    const aRemaining = Math.max(0, a.target_questions - aTotal);
                    const bRemaining = Math.max(0, b.target_questions - bTotal);
                    
                    switch (currentSort) {
                        case 'name':
                            return a.name.localeCompare(b.name);
                        case 'progress':
                            return bPercentage - aPercentage;
                        case 'deadline':
                            return new Date(a.deadline) - new Date(b.deadline);
                        case 'remaining':
                            return aRemaining - bRemaining;
                        default:
                            return 0;
                    }
                });
            }
            
            if (displaySubjects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>è¡¨ç¤ºã™ã‚‹ç§‘ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = displaySubjects.map(subject => {
                const totalCompleted = dailyProgress
                    .filter(p => p.subject_id === subject.id)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                const percentage = Math.min(100, Math.round((totalCompleted / subject.target_questions) * 100));
                
                const today = new Date().toISOString().split('T')[0];
                const todayCompleted = dailyProgress
                    .filter(p => p.subject_id === subject.id && p.date === today)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                const deleteButtonHtml = !isSharedMode ? `
                    <button onclick="deleteSubject(${subject.id})" 
                        class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
                
                const progressButtonsHtml = !isSharedMode ? `
                    <div class="flex items-center space-x-2">
                        <button onclick="updateProgress(${subject.id}, -1)" 
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="font-semibold px-3">${todayCompleted}</span>
                        <button onclick="updateProgress(${subject.id}, 1)" 
                            class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                ` : `
                    <div class="text-center">
                        <span class="font-semibold">${todayCompleted}</span>
                    </div>
                `;
                
                const isComplete = totalCompleted >= subject.target_questions;
                const remaining = Math.max(0, subject.target_questions - totalCompleted);
                
                // æœŸé™ã¾ã§ã®æ—¥æ•°è¨ˆç®—
                const deadline = new Date(subject.deadline);
                const now = new Date();
                const daysRemaining = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                const deadlineColor = daysRemaining < 7 ? 'text-red-600' : daysRemaining < 30 ? 'text-yellow-600' : 'text-gray-600';
                const statusEmoji = isComplete ? 'âœ…' : percentage >= 50 ? 'ğŸ“‹' : 'ğŸ“';
                
                return `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition ${isComplete ? 'bg-green-50 border-green-300' : ''}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-grow">
                                <h3 class="font-semibold text-lg">${statusEmoji} ${subject.name}</h3>
                                <p class="text-sm ${deadlineColor}">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    æœŸé™: ${subject.deadline} 
                                    ${daysRemaining > 0 ? `(æ®‹ã‚Š${daysRemaining}æ—¥)` : daysRemaining === 0 ? '(ä»Šæ—¥ã¾ã§)' : '(æœŸé™åˆ‡ã‚Œ)'}
                                </p>
                            </div>
                            ${deleteButtonHtml}
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                            <div class="bg-blue-100 rounded p-2">
                                <div class="text-xs text-gray-600">ç›®æ¨™</div>
                                <div class="font-bold text-blue-600">${subject.target_questions.toLocaleString()}</div>
                                <div class="text-xs">${subject.unit}</div>
                            </div>
                            <div class="bg-green-100 rounded p-2">
                                <div class="text-xs text-gray-600">é”æˆ</div>
                                <div class="font-bold text-green-600">${totalCompleted.toLocaleString()}</div>
                                <div class="text-xs">${subject.unit}</div>
                            </div>
                            <div class="bg-orange-100 rounded p-2">
                                <div class="text-xs text-gray-600">æ®‹ã‚Š</div>
                                <div class="font-bold text-orange-600">${remaining.toLocaleString()}</div>
                                <div class="text-xs">${subject.unit}</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span>é€²æ—ç‡</span>
                                <span class="font-bold ${isComplete ? 'text-green-600' : percentage >= 50 ? 'text-blue-600' : 'text-gray-600'}">
                                    ${percentage}%
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="${isComplete ? 'bg-green-500' : percentage >= 50 ? 'bg-blue-500' : 'bg-gray-400'} h-3 rounded-full transition-all duration-500" 
                                    style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">ä»Šæ—¥ã®é€²æ—</span>
                            ${progressButtonsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateSummary() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            
            const todayTotal = dailyProgress
                .filter(p => p.date === today)
                .reduce((sum, p) => sum + p.completed_count, 0);
            
            const weekTotal = dailyProgress
                .filter(p => p.date >= weekAgoStr)
                .reduce((sum, p) => sum + p.completed_count, 0);
            
            const total = dailyProgress
                .reduce((sum, p) => sum + p.completed_count, 0);
            
            // å¹³å‡é€²æ—ç‡ã‚’è¨ˆç®—
            let totalPercentage = 0;
            let completedCount = 0;
            subjects.forEach(subject => {
                const subjectTotal = dailyProgress
                    .filter(p => p.subject_id === subject.id)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                const percentage = Math.min(100, Math.round((subjectTotal / subject.target_questions) * 100));
                totalPercentage += percentage;
                if (percentage === 100) completedCount++;
            });
            const avgPercentage = subjects.length > 0 ? Math.round(totalPercentage / subjects.length) : 0;
            
            document.getElementById('todayProgress').textContent = `${todayTotal}`;
            document.getElementById('weekProgress').textContent = `${weekTotal}`;
            document.getElementById('totalProgress').textContent = `${total}`;
            
            // å¹³å‡é€²æ—ç‡ã‚’è¡¨ç¤ºï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            const avgElement = document.getElementById('avgProgress');
            if (avgElement) {
                avgElement.textContent = `${avgPercentage}%`;
            }
        }

        // ã‚°ãƒ©ãƒ•åˆæœŸåŒ–
        function initCharts() {
            // Chart.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }
            
            // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (charts.daily && charts.completion) {
                updateCharts();
                return;
            }
            
            // æ—¥åˆ¥é€²æ—ã‚°ãƒ©ãƒ•
            const dailyCanvas = document.getElementById('dailyChart');
            if (!dailyCanvas) {
                console.error('Daily chart canvas not found');
                return;
            }
            const dailyCtx = dailyCanvas.getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å®Œäº†æ•°',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // ç§‘ç›®åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•
            const completionCanvas = document.getElementById('completionChart');
            if (!completionCanvas) {
                console.error('Completion chart canvas not found');
                return;
            }
            const completionCtx = completionCanvas.getContext('2d');
            charts.completion = new Chart(completionCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.5)',
                            'rgba(16, 185, 129, 0.5)',
                            'rgba(251, 146, 60, 0.5)',
                            'rgba(168, 85, 247, 0.5)',
                            'rgba(251, 113, 133, 0.5)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateCharts() {
            // ãƒãƒ£ãƒ¼ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!charts.daily || !charts.completion) {
                console.warn('Charts not initialized yet');
                return;
            }
            
            // æ—¥åˆ¥é€²æ—ãƒ‡ãƒ¼ã‚¿
            const last7Days = [];
            const dailyData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayLabel = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                
                last7Days.push(dayLabel);
                
                const dayTotal = dailyProgress
                    .filter(p => p.date === dateStr)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                dailyData.push(dayTotal);
            }
            
            if (charts.daily && charts.daily.data) {
                charts.daily.data.labels = last7Days;
                charts.daily.data.datasets[0].data = dailyData;
                charts.daily.update();
            }
            
            // ç§‘ç›®åˆ¥é”æˆç‡ãƒ‡ãƒ¼ã‚¿
            const completionLabels = [];
            const completionData = [];
            
            subjects.forEach(subject => {
                const total = dailyProgress
                    .filter(p => p.subject_id === subject.id)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                const percentage = Math.min(100, Math.round((total / subject.target_questions) * 100));
                
                completionLabels.push(subject.name);
                completionData.push(percentage);
            });
            
            if (charts.completion && charts.completion.data) {
                charts.completion.data.labels = completionLabels;
                charts.completion.data.datasets[0].data = completionData;
                charts.completion.update();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿åœ§ç¸®é–¢æ•°
        function compressData(data) {
            // ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æœ€å°åŒ–
            const compressed = {
                s: data.subjects.map(s => ({
                    i: s.id,
                    n: s.name,
                    t: s.target_questions,
                    d: s.deadline,
                    u: s.unit
                })),
                p: data.dailyProgress.map(p => ({
                    i: p.id,
                    si: p.subject_id,
                    d: p.date,
                    c: p.completed_count
                }))
            };
            return compressed;
        }
        
        // ãƒ‡ãƒ¼ã‚¿å±•é–‹é–¢æ•°
        function decompressData(compressed) {
            return {
                subjects: compressed.s.map(s => ({
                    id: s.i,
                    name: s.n,
                    target_questions: s.t,
                    deadline: s.d,
                    unit: s.u
                })),
                dailyProgress: compressed.p.map(p => ({
                    id: p.i,
                    subject_id: p.si,
                    date: p.d,
                    completed_count: p.c
                }))
            };
        }
        
        // å…±æœ‰URLç”Ÿæˆ
        function generateShareUrl() {
            if (isSharedMode) {
                showNotification('é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯å…±æœ‰URLã‚’ç”Ÿæˆã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            const shareData = {
                subjects: subjects,
                dailyProgress: dailyProgress
            };
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®
            const compressed = compressData(shareData);
            const encodedData = btoa(JSON.stringify(compressed));
            const currentUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${currentUrl}?data=${encodedData}`;
            
            // URLã®é•·ã•ã‚’ãƒã‚§ãƒƒã‚¯
            if (shareUrl.length > 8000) {
                showNotification('\u26a0\ufe0f ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã‚‹ãŸã‚ã€ä¸€éƒ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', 'warning');
            }
            
            const display = document.getElementById('shareUrlDisplay');
            display.textContent = shareUrl;
            display.classList.remove('hidden');
            
            // URLé•·ã•æƒ…å ±ã‚’è¡¨ç¤º
            console.log(`å…±æœ‰URLé•·: ${shareUrl.length}æ–‡å­—`);
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(shareUrl).then(() => {
                showNotification(`å…±æœ‰URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆ${shareUrl.length}æ–‡å­—ï¼‰`, 'success');
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const exportData = {
                subjects: subjects,
                dailyProgress: dailyProgress,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `study-progress-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData() {
            if (isSharedMode) {
                showNotification('é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    subjects = importedData.subjects || [];
                    dailyProgress = importedData.dailyProgress || [];
                    saveData();
                    updateDisplay();
                    closeDataModal();
                    showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            };
            reader.readAsText(file);
        }

        // LocalStorageãƒ‡ãƒãƒƒã‚°æƒ…å ±
        function debugLocalStorage() {
            const subjects = localStorage.getItem('studySubjects');
            const progress = localStorage.getItem('studyProgress');
            
            let message = 'LocalStorageãƒ‡ãƒãƒƒã‚°æƒ…å ±:\n\n';
            
            if (subjects) {
                try {
                    const subjectsData = JSON.parse(subjects);
                    message += `ç§‘ç›®ãƒ‡ãƒ¼ã‚¿: ${subjectsData.length}ç§‘ç›®\n`;
                    subjectsData.slice(0, 3).forEach(s => {
                        message += `  - ${s.name} (ç›®æ¨™: ${s.target_questions}${s.unit || ''})\n`;
                    });
                    if (subjectsData.length > 3) {
                        message += `  ... ä»–${subjectsData.length - 3}ç§‘ç›®\n`;
                    }
                } catch (e) {
                    message += `ç§‘ç›®ãƒ‡ãƒ¼ã‚¿: ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ (${e.message})\n`;
                }
            } else {
                message += 'ç§‘ç›®ãƒ‡ãƒ¼ã‚¿: ãªã—\n';
            }
            
            message += '\n';
            
            if (progress) {
                try {
                    const progressData = JSON.parse(progress);
                    message += `é€²æ—ãƒ‡ãƒ¼ã‚¿: ${progressData.length}ä»¶\n`;
                    const total = progressData.reduce((sum, p) => sum + p.completed_count, 0);
                    message += `ç·é€²æ—æ•°: ${total.toLocaleString()}\n`;
                } catch (e) {
                    message += `é€²æ—ãƒ‡ãƒ¼ã‚¿: ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ (${e.message})\n`;
                }
            } else {
                message += 'é€²æ—ãƒ‡ãƒ¼ã‚¿: ãªã—\n';
            }
            
            message += '\nLocalStorageã‚­ãƒ¼ä¸€è¦§:\n';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('study') || key.includes('Study')) {
                    const value = localStorage.getItem(key);
                    message += `  - ${key} (${value ? value.length : 0}æ–‡å­—)\n`;
                }
            }
            
            alert(message);
            console.log(message);
        }
        
        // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            const select = document.getElementById('historySubjectSelect');
            
            // ç§‘ç›®é¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            select.innerHTML = '<option value="all">ã™ã¹ã¦ã®ç§‘ç›®</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
            
            modal.classList.remove('hidden');
            updateHistoryDisplay();
        }
        
        // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }
        
        // å±¥æ­´è¡¨ç¤ºã‚’æ›´æ–°
        function updateHistoryDisplay() {
            const select = document.getElementById('historySubjectSelect');
            const content = document.getElementById('historyContent');
            const selectedId = select.value;
            
            let filteredProgress = dailyProgress;
            if (selectedId !== 'all') {
                filteredProgress = dailyProgress.filter(p => p.subject_id == selectedId);
            }
            
            // æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedByDate = {};
            filteredProgress.forEach(progress => {
                if (!groupedByDate[progress.date]) {
                    groupedByDate[progress.date] = [];
                }
                groupedByDate[progress.date].push(progress);
            });
            
            // æ—¥ä»˜ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
            
            if (sortedDates.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-4">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            content.innerHTML = sortedDates.map(date => {
                const dayProgress = groupedByDate[date];
                const totalCount = dayProgress.reduce((sum, p) => sum + p.completed_count, 0);
                
                return `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">
                                <i class="fas fa-calendar-day mr-2"></i>
                                ${date}
                            </h4>
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                                åˆè¨ˆ: ${totalCount}
                            </span>
                        </div>
                        <div class="space-y-1">
                            ${dayProgress.map(p => {
                                const subject = subjects.find(s => s.id === p.subject_id);
                                if (!subject) return '';
                                return `
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-600">${subject.name}</span>
                                        <span class="font-medium">${p.completed_count}${subject.unit}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilter() {
            const filterValue = document.getElementById('filterSelect').value;
            currentFilter = filterValue;
            updateSubjectsList();
        }
        
        // ã‚½ãƒ¼ãƒˆé©ç”¨
        function applySort() {
            const sortValue = document.getElementById('sortSelect').value;
            currentSort = sortValue;
            updateSubjectsList();
        }
        
        // å…±æœ‰ãƒ“ãƒ¥ãƒ¼ã‚’é–‹ã
        function openShareView() {
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã§å…±æœ‰URLã‚’ç”Ÿæˆ
            const shareData = {
                subjects: subjects,
                dailyProgress: dailyProgress
            };
            
            const compressed = compressData(shareData);
            const encodedData = btoa(JSON.stringify(compressed));
            
            // å…±æœ‰ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
            const shareUrl = `share.html?data=${encodedData}`;
            window.open(shareUrl, '_blank');
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function resetData() {
            if (isSharedMode) {
                showNotification('é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒªã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                subjects = [];
                dailyProgress = [];
                saveData();
                updateDisplay();
                closeDataModal();
                showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        function openAddSubjectModal() {
            if (isSharedMode) {
                showNotification('é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç§‘ç›®ã‚’è¿½åŠ ã§ãã¾ã›ã‚“', 'warning');
                return;
            }
            document.getElementById('addSubjectModal').classList.remove('hidden');
        }

        function closeAddSubjectModal() {
            document.getElementById('addSubjectModal').classList.add('hidden');
            document.getElementById('subjectName').value = '';
            document.getElementById('targetQuestions').value = '';
            document.getElementById('deadline').value = '';
        }

        function openDataModal() {
            document.getElementById('dataModal').classList.remove('hidden');
        }

        function closeDataModal() {
            document.getElementById('dataModal').classList.add('hidden');
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html><!-- Updated: Thu Aug 21 19:41:30 UTC 2025 -->
