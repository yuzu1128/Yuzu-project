<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学習進捗管理ダッシュボード（完全版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* 共有モード時の無効化スタイル */
        .shared-mode-disabled {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .shared-mode-hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- ヘッダー -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-graduation-cap mr-2"></i>
                    学習進捗管理ダッシュボード
                </h1>
                <div class="flex items-center space-x-4">
                    <!-- 共有モード表示 -->
                    <div id="sharedModeIndicator" class="hidden bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-eye mr-1"></i>
                        閲覧専用モード
                    </div>
                    
                    <!-- データ管理ボタン -->
                    <button id="dataManageBtn" onclick="openDataModal()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                        <i class="fas fa-database mr-2"></i>
                        データ管理
                    </button>
                </div>
            </div>
        </div>

        <!-- 進捗サマリー -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">今日の進捗</p>
                        <p class="text-2xl font-bold text-blue-600" id="todayProgress">0問</p>
                    </div>
                    <i class="fas fa-calendar-day text-3xl text-blue-200"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">今週の進捗</p>
                        <p class="text-2xl font-bold text-green-600" id="weekProgress">0問</p>
                    </div>
                    <i class="fas fa-calendar-week text-3xl text-green-200"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">総進捗</p>
                        <p class="text-2xl font-bold text-purple-600" id="totalProgress">0問</p>
                    </div>
                    <i class="fas fa-chart-line text-3xl text-purple-200"></i>
                </div>
            </div>
        </div>

        <!-- 科目リスト -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">
                    <i class="fas fa-books mr-2"></i>
                    科目一覧
                </h2>
                <div class="flex gap-2">
                    <!-- フィルター -->
                    <select id="filterSelect" onchange="applyFilter()" class="border rounded px-3 py-2 text-sm">
                        <option value="all">すべて表示</option>
                        <option value="incomplete">未完了のみ</option>
                        <option value="complete">完了済み</option>
                        <option value="deadline-near">期限が近い</option>
                        <option value="deadline-over">期限切れ</option>
                    </select>
                    <!-- 並び替え -->
                    <select id="sortSelect" onchange="applySort()" class="border rounded px-3 py-2 text-sm">
                        <option value="default">推奨順（達成率順・完了は下）</option>
                        <option value="name">名前順</option>
                        <option value="progress">進捗率順（完了含む）</option>
                        <option value="deadline">期限順</option>
                        <option value="remaining">残り数順</option>
                    </select>
                    <!-- 履歴ボタン -->
                    <button onclick="openHistoryModal()" class="bg-indigo-500 text-white px-3 py-2 rounded hover:bg-indigo-600 transition text-sm">
                        <i class="fas fa-history"></i>
                    </button>
                    <button id="addSubjectBtn" onclick="openAddSubjectModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                        <i class="fas fa-plus mr-2"></i>
                        科目追加
                    </button>
                </div>
            </div>
            
            <div id="subjectsList" class="space-y-4">
                <!-- 科目カードがここに動的に追加される -->
            </div>
        </div>

        <!-- グラフエリア -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-bar mr-2"></i>
                    日別進捗
                </h3>
                <canvas id="dailyChart"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-pie mr-2"></i>
                    科目別達成率
                </h3>
                <canvas id="completionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 科目追加モーダル -->
    <div id="addSubjectModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0" onclick="closeAddSubjectModal()"></div>
        <div class="bg-white rounded-lg p-6 w-96 relative z-10 slide-up">
            <h3 class="text-xl font-semibold mb-4">新しい科目を追加</h3>
            <form onsubmit="addSubject(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">科目名</label>
                    <input type="text" id="subjectName" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">目標問題数</label>
                    <input type="number" id="targetQuestions" required min="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">単位</label>
                    <select id="unit" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="問">問</option>
                        <option value="ページ">ページ</option>
                        <option value="章">章</option>
                        <option value="時間">時間</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">期限（オプション）</label>
                    <input type="date" id="deadline" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeAddSubjectModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        キャンセル
                    </button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        追加
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 進捗履歴モーダル -->
    <div id="historyModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0" onclick="closeHistoryModal()"></div>
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl relative z-10 slide-up max-h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-history mr-2"></i>
                進捗履歴
            </h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">科目を選択</label>
                <select id="historySubjectSelect" onchange="updateHistoryDisplay()" class="w-full border rounded px-3 py-2">
                    <option value="all">すべての科目</option>
                </select>
            </div>
            
            <div id="historyContent" class="space-y-2">
                <!-- 履歴がここに表示される -->
            </div>
            
            <div class="flex justify-end mt-4">
                <button onclick="closeHistoryModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- データ管理モーダル -->
    <div id="dataModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0" onclick="closeDataModal()"></div>
        <div class="bg-white rounded-lg p-6 w-96 relative z-10 slide-up">
            <h3 class="text-xl font-semibold mb-4">データ管理</h3>
            
            <div class="space-y-4">
                <!-- 共有URL生成 -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">
                        <i class="fas fa-share-alt mr-2"></i>
                        共有URL生成
                    </h4>
                    <p class="text-sm text-gray-600 mb-2">現在のデータを閲覧専用で共有できます</p>
                    <button onclick="generateShareUrl()" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mb-2">
                        共有URLを生成
                    </button>
                    <button onclick="openShareView()" class="w-full bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                        <i class="fas fa-external-link-alt mr-2"></i>
                        共有ビューを開く
                    </button>
                    <div id="shareUrlDisplay" class="hidden mt-2 p-2 bg-gray-100 rounded text-xs break-all"></div>
                </div>
                
                <!-- データエクスポート -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">
                        <i class="fas fa-download mr-2"></i>
                        データエクスポート
                    </h4>
                    <button onclick="exportData()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        JSONファイルとして保存
                    </button>
                </div>
                
                <!-- データインポート -->
                <div class="border rounded-lg p-4">
                    <h4 class="font-medium mb-2">
                        <i class="fas fa-upload mr-2"></i>
                        データインポート
                    </h4>
                    <input type="file" id="importFile" accept=".json" class="w-full mb-2">
                    <button onclick="importData()" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        データを読み込む
                    </button>
                </div>
                
                <!-- データ移行 -->
                <div class="border rounded-lg p-4 border-purple-200 mb-4">
                    <h4 class="font-medium mb-2 text-purple-600">
                        <i class="fas fa-exchange-alt mr-2"></i>
                        データ移行
                    </h4>
                    <a href="./data-migration.html" class="block w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-center mb-2">
                        データ移行ツールを開く
                    </a>
                    <button onclick="debugLocalStorage()" class="w-full bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-bug mr-2"></i>
                        LocalStorageデバッグ情報
                    </button>
                </div>
                
                <!-- データリセット -->
                <div class="border rounded-lg p-4 border-red-200">
                    <h4 class="font-medium mb-2 text-red-600">
                        <i class="fas fa-trash-alt mr-2"></i>
                        データリセット
                    </h4>
                    <button onclick="resetData()" class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        すべてのデータを削除
                    </button>
                </div>
            </div>
            
            <div class="flex justify-end mt-4">
                <button onclick="closeDataModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let subjects = [];
        let dailyProgress = [];
        let charts = {};
        let isSharedMode = false;
        let currentFilter = 'all';
        let currentSort = 'default';

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // アプリケーション初期化
        function initializeApp() {
            // URLパラメータチェック
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            
            if (sharedData) {
                // 共有モードで起動
                isSharedMode = true;
                try {
                    const decodedData = JSON.parse(atob(sharedData));
                    
                    // 圧縮されたデータかどうかチェック
                    if (decodedData.s && decodedData.p) {
                        // 圧縮データを展開
                        const decompressed = decompressData(decodedData);
                        subjects = decompressed.subjects || [];
                        dailyProgress = decompressed.dailyProgress || [];
                    } else {
                        // 古い形式のデータ（互換性保持）
                        subjects = decodedData.subjects || [];
                        dailyProgress = decodedData.dailyProgress || [];
                    }
                    
                    // 共有モードの表示設定
                    document.getElementById('sharedModeIndicator').classList.remove('hidden');
                    
                    // 編集機能を無効化
                    disableEditingFeatures();
                    
                    showNotification('共有データを読み込みました（閲覧専用）', 'info');
                } catch (error) {
                    console.error('共有データの読み込みに失敗:', error);
                    showNotification('共有データの読み込みに失敗しました', 'error');
                    loadDataFromLocalStorage();
                }
            } else {
                // 通常モード
                loadDataFromLocalStorage();
            }
            
            updateDisplay();
            
            // Chart.jsが読み込まれるまで待つ
            if (typeof Chart !== 'undefined') {
                initCharts();
            } else {
                // Chart.jsがまだ読み込まれていない場合、少し待ってから再試行
                setTimeout(() => {
                    if (typeof Chart !== 'undefined') {
                        initCharts();
                    } else {
                        console.warn('Chart.js could not be loaded');
                    }
                }, 1000);
            }
        }

        // 編集機能の無効化
        function disableEditingFeatures() {
            // ボタンを無効化
            const editButtons = [
                'addSubjectBtn',
                'dataManageBtn'
            ];
            
            editButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.add('shared-mode-disabled');
                    btn.disabled = true;
                }
            });
            
            // データ管理ボタンのテキストを変更
            const dataBtn = document.getElementById('dataManageBtn');
            if (dataBtn) {
                dataBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>閲覧専用';
            }
        }

        // ローカルストレージからデータ読み込み
        function loadDataFromLocalStorage() {
            const savedSubjects = localStorage.getItem('studySubjects');
            const savedProgress = localStorage.getItem('studyProgress');
            
            console.log('LocalStorageからデータ読み込み...');
            
            if (savedSubjects) {
                try {
                    subjects = JSON.parse(savedSubjects);
                    console.log('科目データ読み込み成功:', subjects.length, '科目');
                } catch (e) {
                    console.error('科目データのパースに失敗:', e);
                    subjects = [];
                }
            } else {
                console.log('科目データが見つかりません');
                subjects = [];
            }
            
            if (savedProgress) {
                try {
                    dailyProgress = JSON.parse(savedProgress);
                    console.log('進捗データ読み込み成功:', dailyProgress.length, '件');
                } catch (e) {
                    console.error('進捗データのパースに失敗:', e);
                    dailyProgress = [];
                }
            } else {
                console.log('進捗データが見つかりません');
                dailyProgress = [];
            }
            
            // データが空の場合のみサンプルデータを設定
            if (subjects.length === 0 && dailyProgress.length === 0) {
                console.log('データが空なのでサンプルデータを表示');
                subjects = [
                    {
                        id: Date.now(),
                        name: "サンプル科目（データ移行ツールを使用してください）",
                        target_questions: 100,
                        unit: "問",
                        deadline: "2025-12-31",
                        order_index: 0,
                        created_at: new Date().toISOString()
                    }
                ];
            }
        }

        // データ保存
        function saveData() {
            if (!isSharedMode) {
                localStorage.setItem('studySubjects', JSON.stringify(subjects));
                localStorage.setItem('studyProgress', JSON.stringify(dailyProgress));
            }
        }

        // 科目追加
        function addSubject(event) {
            event.preventDefault();
            
            if (isSharedMode) {
                showNotification('閲覧専用モードでは編集できません', 'warning');
                return;
            }
            
            const newSubject = {
                id: Date.now(),
                name: document.getElementById('subjectName').value,
                target_questions: parseInt(document.getElementById('targetQuestions').value),
                unit: document.getElementById('unit').value,
                deadline: document.getElementById('deadline').value || null,
                order_index: subjects.length,
                created_at: new Date().toISOString()
            };
            
            subjects.push(newSubject);
            saveData();
            updateDisplay();
            closeAddSubjectModal();
            showNotification('科目を追加しました', 'success');
        }

        // 進捗更新
        function updateProgress(subjectId, increment) {
            if (isSharedMode) {
                showNotification('閲覧専用モードでは編集できません', 'warning');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            let todayProgress = dailyProgress.find(p => 
                p.subject_id === subjectId && p.date === today
            );
            
            if (todayProgress) {
                todayProgress.completed_count += increment;
                if (todayProgress.completed_count < 0) {
                    todayProgress.completed_count = 0;
                }
            } else {
                if (increment > 0) {
                    dailyProgress.push({
                        id: Date.now(),
                        subject_id: subjectId,
                        date: today,
                        completed_count: increment,
                        created_at: new Date().toISOString()
                    });
                }
            }
            
            saveData();
            updateDisplay();
        }

        // 科目削除
        function deleteSubject(subjectId) {
            if (isSharedMode) {
                showNotification('閲覧専用モードでは編集できません', 'warning');
                return;
            }
            
            if (confirm('この科目を削除してもよろしいですか？')) {
                subjects = subjects.filter(s => s.id !== subjectId);
                dailyProgress = dailyProgress.filter(p => p.subject_id !== subjectId);
                saveData();
                updateDisplay();
                showNotification('科目を削除しました', 'success');
            }
        }

        // 表示更新
        function updateDisplay() {
            updateSubjectsList();
            updateSummary();
            updateCharts();
        }

        // 科目リスト更新
        function updateSubjectsList() {
            const container = document.getElementById('subjectsList');
            
            let displaySubjects = [...subjects];
            
            // フィルター適用
            if (currentFilter !== 'all') {
                displaySubjects = displaySubjects.filter(subject => {
                    const totalCompleted = dailyProgress
                        .filter(p => p.subject_id === subject.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    const percentage = Math.min(100, Math.round((totalCompleted / subject.target_questions) * 100));
                    const isComplete = totalCompleted >= subject.target_questions;
                    
                    const deadline = new Date(subject.deadline);
                    const now = new Date();
                    const daysRemaining = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                    
                    switch (currentFilter) {
                        case 'incomplete':
                            return !isComplete;
                        case 'complete':
                            return isComplete;
                        case 'deadline-near':
                            return daysRemaining <= 7 && daysRemaining > 0;
                        case 'deadline-over':
                            return daysRemaining < 0;
                        default:
                            return true;
                    }
                });
            }
            
            // ソート適用
            if (currentSort === 'default') {
                // デフォルト: 完了済みは下、未完了は達成率順
                displaySubjects.sort((a, b) => {
                    const aTotal = dailyProgress.filter(p => p.subject_id === a.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    const bTotal = dailyProgress.filter(p => p.subject_id === b.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    
                    const aPercentage = Math.min(100, Math.round((aTotal / a.target_questions) * 100));
                    const bPercentage = Math.min(100, Math.round((bTotal / b.target_questions) * 100));
                    
                    // 100%の科目を下に
                    if (aPercentage === 100 && bPercentage !== 100) return 1;
                    if (aPercentage !== 100 && bPercentage === 100) return -1;
                    
                    // 両方100%の場合は名前順
                    if (aPercentage === 100 && bPercentage === 100) {
                        return a.name.localeCompare(b.name);
                    }
                    
                    // 両方100%未満の場合は達成率が高い順
                    return bPercentage - aPercentage;
                });
            } else if (currentSort !== 'default') {
                displaySubjects.sort((a, b) => {
                    const aTotal = dailyProgress.filter(p => p.subject_id === a.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    const bTotal = dailyProgress.filter(p => p.subject_id === b.id)
                        .reduce((sum, p) => sum + p.completed_count, 0);
                    
                    const aPercentage = Math.min(100, Math.round((aTotal / a.target_questions) * 100));
                    const bPercentage = Math.min(100, Math.round((bTotal / b.target_questions) * 100));
                    
                    const aRemaining = Math.max(0, a.target_questions - aTotal);
                    const bRemaining = Math.max(0, b.target_questions - bTotal);
                    
                    switch (currentSort) {
                        case 'name':
                            return a.name.localeCompare(b.name);
                        case 'progress':
                            return bPercentage - aPercentage;
                        case 'deadline':
                            return new Date(a.deadline) - new Date(b.deadline);
                        case 'remaining':
                            return aRemaining - bRemaining;
                        default:
                            return 0;
                    }
                });
            }
            
            if (displaySubjects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>表示する科目がありません</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = displaySubjects.map(subject => {
                const totalCompleted = dailyProgress
                    .filter(p => p.subject_id === subject.id)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                const percentage = Math.min(100, Math.round((totalCompleted / subject.target_questions) * 100));
                
                const today = new Date().toISOString().split('T')[0];
                const todayCompleted = dailyProgress
                    .filter(p => p.subject_id === subject.id && p.date === today)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                const deleteButtonHtml = !isSharedMode ? `
                    <button onclick="deleteSubject(${subject.id})" 
                        class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : '';
                
                const progressButtonsHtml = !isSharedMode ? `
                    <div class="flex items-center space-x-2">
                        <button onclick="updateProgress(${subject.id}, -1)" 
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="font-semibold px-3">${todayCompleted}</span>
                        <button onclick="updateProgress(${subject.id}, 1)" 
                            class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                ` : `
                    <div class="text-center">
                        <span class="font-semibold">${todayCompleted}</span>
                    </div>
                `;
                
                const isComplete = totalCompleted >= subject.target_questions;
                const remaining = Math.max(0, subject.target_questions - totalCompleted);
                
                // 期限までの日数計算
                const deadline = new Date(subject.deadline);
                const now = new Date();
                const daysRemaining = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                const deadlineColor = daysRemaining < 7 ? 'text-red-600' : daysRemaining < 30 ? 'text-yellow-600' : 'text-gray-600';
                const statusEmoji = isComplete ? '✅' : percentage >= 50 ? '📋' : '📝';
                
                return `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition ${isComplete ? 'bg-green-50 border-green-300' : ''}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-grow">
                                <h3 class="font-semibold text-lg">${statusEmoji} ${subject.name}</h3>
                                <p class="text-sm ${deadlineColor}">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    期限: ${subject.deadline} 
                                    ${daysRemaining > 0 ? `(残り${daysRemaining}日)` : daysRemaining === 0 ? '(今日まで)' : '(期限切れ)'}
                                </p>
                            </div>
                            ${deleteButtonHtml}
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                            <div class="bg-blue-100 rounded p-2">
                                <div class="text-xs text-gray-600">目標</div>
                                <div class="font-bold text-blue-600">${subject.target_questions.toLocaleString()}</div>
                                <div class="text-xs">${subject.unit}</div>
                            </div>
                            <div class="bg-green-100 rounded p-2">
                                <div class="text-xs text-gray-600">達成</div>
                                <div class="font-bold text-green-600">${totalCompleted.toLocaleString()}</div>
                                <div class="text-xs">${subject.unit}</div>
                            </div>
                            <div class="bg-orange-100 rounded p-2">
                                <div class="text-xs text-gray-600">残り</div>
                                <div class="font-bold text-orange-600">${remaining.toLocaleString()}</div>
                                <div class="text-xs">${subject.unit}</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span>進捗率</span>
                                <span class="font-bold ${isComplete ? 'text-green-600' : percentage >= 50 ? 'text-blue-600' : 'text-gray-600'}">
                                    ${percentage}%
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="${isComplete ? 'bg-green-500' : percentage >= 50 ? 'bg-blue-500' : 'bg-gray-400'} h-3 rounded-full transition-all duration-500" 
                                    style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">今日の進捗</span>
                            ${progressButtonsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // サマリー更新
        function updateSummary() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            
            const todayTotal = dailyProgress
                .filter(p => p.date === today)
                .reduce((sum, p) => sum + p.completed_count, 0);
            
            const weekTotal = dailyProgress
                .filter(p => p.date >= weekAgoStr)
                .reduce((sum, p) => sum + p.completed_count, 0);
            
            const total = dailyProgress
                .reduce((sum, p) => sum + p.completed_count, 0);
            
            // 平均進捗率を計算
            let totalPercentage = 0;
            let completedCount = 0;
            subjects.forEach(subject => {
                const subjectTotal = dailyProgress
                    .filter(p => p.subject_id === subject.id)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                const percentage = Math.min(100, Math.round((subjectTotal / subject.target_questions) * 100));
                totalPercentage += percentage;
                if (percentage === 100) completedCount++;
            });
            const avgPercentage = subjects.length > 0 ? Math.round(totalPercentage / subjects.length) : 0;
            
            document.getElementById('todayProgress').textContent = `${todayTotal}`;
            document.getElementById('weekProgress').textContent = `${weekTotal}`;
            document.getElementById('totalProgress').textContent = `${total}`;
            
            // 平均進捗率を表示（要素が存在する場合）
            const avgElement = document.getElementById('avgProgress');
            if (avgElement) {
                avgElement.textContent = `${avgPercentage}%`;
            }
        }

        // グラフ初期化
        function initCharts() {
            // Chart.jsが読み込まれていない場合はスキップ
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }
            
            // 既に初期化済みの場合はスキップ
            if (charts.daily && charts.completion) {
                updateCharts();
                return;
            }
            
            // 日別進捗グラフ
            const dailyCanvas = document.getElementById('dailyChart');
            if (!dailyCanvas) {
                console.error('Daily chart canvas not found');
                return;
            }
            const dailyCtx = dailyCanvas.getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '完了数',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // 科目別達成率グラフ
            const completionCanvas = document.getElementById('completionChart');
            if (!completionCanvas) {
                console.error('Completion chart canvas not found');
                return;
            }
            const completionCtx = completionCanvas.getContext('2d');
            charts.completion = new Chart(completionCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.5)',
                            'rgba(16, 185, 129, 0.5)',
                            'rgba(251, 146, 60, 0.5)',
                            'rgba(168, 85, 247, 0.5)',
                            'rgba(251, 113, 133, 0.5)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // グラフ更新
        function updateCharts() {
            // チャートが初期化されていない場合は何もしない
            if (!charts.daily || !charts.completion) {
                console.warn('Charts not initialized yet');
                return;
            }
            
            // 日別進捗データ
            const last7Days = [];
            const dailyData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayLabel = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                
                last7Days.push(dayLabel);
                
                const dayTotal = dailyProgress
                    .filter(p => p.date === dateStr)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                dailyData.push(dayTotal);
            }
            
            if (charts.daily && charts.daily.data) {
                charts.daily.data.labels = last7Days;
                charts.daily.data.datasets[0].data = dailyData;
                charts.daily.update();
            }
            
            // 科目別達成率データ
            const completionLabels = [];
            const completionData = [];
            
            subjects.forEach(subject => {
                const total = dailyProgress
                    .filter(p => p.subject_id === subject.id)
                    .reduce((sum, p) => sum + p.completed_count, 0);
                
                const percentage = Math.min(100, Math.round((total / subject.target_questions) * 100));
                
                completionLabels.push(subject.name);
                completionData.push(percentage);
            });
            
            if (charts.completion && charts.completion.data) {
                charts.completion.data.labels = completionLabels;
                charts.completion.data.datasets[0].data = completionData;
                charts.completion.update();
            }
        }

        // データ圧縮関数
        function compressData(data) {
            // 不要なフィールドを削除してデータを最小化
            const compressed = {
                s: data.subjects.map(s => ({
                    i: s.id,
                    n: s.name,
                    t: s.target_questions,
                    d: s.deadline,
                    u: s.unit
                })),
                p: data.dailyProgress.map(p => ({
                    i: p.id,
                    si: p.subject_id,
                    d: p.date,
                    c: p.completed_count
                }))
            };
            return compressed;
        }
        
        // データ展開関数
        function decompressData(compressed) {
            return {
                subjects: compressed.s.map(s => ({
                    id: s.i,
                    name: s.n,
                    target_questions: s.t,
                    deadline: s.d,
                    unit: s.u
                })),
                dailyProgress: compressed.p.map(p => ({
                    id: p.i,
                    subject_id: p.si,
                    date: p.d,
                    completed_count: p.c
                }))
            };
        }
        
        // 共有URL生成
        function generateShareUrl() {
            if (isSharedMode) {
                showNotification('閲覧専用モードでは共有URLを生成できません', 'warning');
                return;
            }
            
            const shareData = {
                subjects: subjects,
                dailyProgress: dailyProgress
            };
            
            // データを圧縮
            const compressed = compressData(shareData);
            const encodedData = btoa(JSON.stringify(compressed));
            const currentUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${currentUrl}?data=${encodedData}`;
            
            // URLの長さをチェック
            if (shareUrl.length > 8000) {
                showNotification('\u26a0\ufe0f データが大きすぎるため、一部のブラウザで問題が発生する可能性があります', 'warning');
            }
            
            const display = document.getElementById('shareUrlDisplay');
            display.textContent = shareUrl;
            display.classList.remove('hidden');
            
            // URL長さ情報を表示
            console.log(`共有URL長: ${shareUrl.length}文字`);
            
            // クリップボードにコピー
            navigator.clipboard.writeText(shareUrl).then(() => {
                showNotification(`共有URLをクリップボードにコピーしました（${shareUrl.length}文字）`, 'success');
            });
        }

        // データエクスポート
        function exportData() {
            const exportData = {
                subjects: subjects,
                dailyProgress: dailyProgress,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `study-progress-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification('データをエクスポートしました', 'success');
        }

        // データインポート
        function importData() {
            if (isSharedMode) {
                showNotification('閲覧専用モードではインポートできません', 'warning');
                return;
            }
            
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('ファイルを選択してください', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    subjects = importedData.subjects || [];
                    dailyProgress = importedData.dailyProgress || [];
                    saveData();
                    updateDisplay();
                    closeDataModal();
                    showNotification('データをインポートしました', 'success');
                } catch (error) {
                    showNotification('ファイルの読み込みに失敗しました', 'error');
                }
            };
            reader.readAsText(file);
        }

        // LocalStorageデバッグ情報
        function debugLocalStorage() {
            const subjects = localStorage.getItem('studySubjects');
            const progress = localStorage.getItem('studyProgress');
            
            let message = 'LocalStorageデバッグ情報:\n\n';
            
            if (subjects) {
                try {
                    const subjectsData = JSON.parse(subjects);
                    message += `科目データ: ${subjectsData.length}科目\n`;
                    subjectsData.slice(0, 3).forEach(s => {
                        message += `  - ${s.name} (目標: ${s.target_questions}${s.unit || ''})\n`;
                    });
                    if (subjectsData.length > 3) {
                        message += `  ... 他${subjectsData.length - 3}科目\n`;
                    }
                } catch (e) {
                    message += `科目データ: パースエラー (${e.message})\n`;
                }
            } else {
                message += '科目データ: なし\n';
            }
            
            message += '\n';
            
            if (progress) {
                try {
                    const progressData = JSON.parse(progress);
                    message += `進捗データ: ${progressData.length}件\n`;
                    const total = progressData.reduce((sum, p) => sum + p.completed_count, 0);
                    message += `総進捗数: ${total.toLocaleString()}\n`;
                } catch (e) {
                    message += `進捗データ: パースエラー (${e.message})\n`;
                }
            } else {
                message += '進捗データ: なし\n';
            }
            
            message += '\nLocalStorageキー一覧:\n';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('study') || key.includes('Study')) {
                    const value = localStorage.getItem(key);
                    message += `  - ${key} (${value ? value.length : 0}文字)\n`;
                }
            }
            
            alert(message);
            console.log(message);
        }
        
        // 履歴モーダルを開く
        function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            const select = document.getElementById('historySubjectSelect');
            
            // 科目選択オプションを更新
            select.innerHTML = '<option value="all">すべての科目</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
            
            modal.classList.remove('hidden');
            updateHistoryDisplay();
        }
        
        // 履歴モーダルを閉じる
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }
        
        // 履歴表示を更新
        function updateHistoryDisplay() {
            const select = document.getElementById('historySubjectSelect');
            const content = document.getElementById('historyContent');
            const selectedId = select.value;
            
            let filteredProgress = dailyProgress;
            if (selectedId !== 'all') {
                filteredProgress = dailyProgress.filter(p => p.subject_id == selectedId);
            }
            
            // 日付でグループ化
            const groupedByDate = {};
            filteredProgress.forEach(progress => {
                if (!groupedByDate[progress.date]) {
                    groupedByDate[progress.date] = [];
                }
                groupedByDate[progress.date].push(progress);
            });
            
            // 日付を降順でソート
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => b.localeCompare(a));
            
            if (sortedDates.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-4">履歴がありません</p>';
                return;
            }
            
            content.innerHTML = sortedDates.map(date => {
                const dayProgress = groupedByDate[date];
                const totalCount = dayProgress.reduce((sum, p) => sum + p.completed_count, 0);
                
                return `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">
                                <i class="fas fa-calendar-day mr-2"></i>
                                ${date}
                            </h4>
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                                合計: ${totalCount}
                            </span>
                        </div>
                        <div class="space-y-1">
                            ${dayProgress.map(p => {
                                const subject = subjects.find(s => s.id === p.subject_id);
                                if (!subject) return '';
                                return `
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-600">${subject.name}</span>
                                        <span class="font-medium">${p.completed_count}${subject.unit}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // フィルター適用
        function applyFilter() {
            const filterValue = document.getElementById('filterSelect').value;
            currentFilter = filterValue;
            updateSubjectsList();
        }
        
        // ソート適用
        function applySort() {
            const sortValue = document.getElementById('sortSelect').value;
            currentSort = sortValue;
            updateSubjectsList();
        }
        
        // 共有ビューを開く
        function openShareView() {
            // 現在のデータで共有URLを生成
            const shareData = {
                subjects: subjects,
                dailyProgress: dailyProgress
            };
            
            const compressed = compressData(shareData);
            const encodedData = btoa(JSON.stringify(compressed));
            
            // 共有ビューページを新しいタブで開く
            const shareUrl = `share.html?data=${encodedData}`;
            window.open(shareUrl, '_blank');
        }
        
        // データリセット
        function resetData() {
            if (isSharedMode) {
                showNotification('閲覧専用モードではリセットできません', 'warning');
                return;
            }
            
            if (confirm('すべてのデータを削除してもよろしいですか？この操作は取り消せません。')) {
                subjects = [];
                dailyProgress = [];
                saveData();
                updateDisplay();
                closeDataModal();
                showNotification('データをリセットしました', 'success');
            }
        }

        // モーダル操作
        function openAddSubjectModal() {
            if (isSharedMode) {
                showNotification('閲覧専用モードでは科目を追加できません', 'warning');
                return;
            }
            document.getElementById('addSubjectModal').classList.remove('hidden');
        }

        function closeAddSubjectModal() {
            document.getElementById('addSubjectModal').classList.add('hidden');
            document.getElementById('subjectName').value = '';
            document.getElementById('targetQuestions').value = '';
            document.getElementById('deadline').value = '';
        }

        function openDataModal() {
            document.getElementById('dataModal').classList.remove('hidden');
        }

        function closeDataModal() {
            document.getElementById('dataModal').classList.add('hidden');
        }

        // 通知表示
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html><!-- Updated: Thu Aug 21 19:41:30 UTC 2025 -->
