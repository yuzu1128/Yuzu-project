<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <!-- é‡è¦ãªãŠçŸ¥ã‚‰ã› -->
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
            <p class="font-bold">ğŸ“¢ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«</p>
            <p class="text-sm mt-1">2025å¹´1æœˆ22æ—¥æ™‚ç‚¹ã®æœ€æ–°å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ï¼ˆ13ç§‘ç›®ã€é€²æ—è¨˜éŒ²å«ã‚€ï¼‰</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold mb-4">
                <i class="fas fa-database mr-2"></i>
                ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«
            </h1>
            
            <div class="mb-6 p-4 bg-blue-50 rounded">
                <h2 class="text-lg font-semibold mb-2">ğŸ“‹ ã“ã®ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹</h2>
                <ol class="list-decimal list-inside space-y-1">
                    <li>ä¸‹ã®ã€Œãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    <li>3ç§’å¾Œã«ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã«è‡ªå‹•ç§»å‹•ã—ã¾ã™</li>
                    <li>ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
                </ol>
            </div>
            
            <div id="statusMessage" class="mb-4"></div>
            
            <button id="migrateBtn" onclick="confirmAndMigrate()" class="bg-blue-500 text-white px-6 py-3 rounded hover:bg-blue-600 transition text-lg font-medium">
                <i class="fas fa-download mr-2"></i>
                ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            </button>
            
            <a href="./index.html" class="inline-block mt-4 bg-green-500 text-white px-6 py-3 rounded hover:bg-green-600 transition">
                <i class="fas fa-home mr-2"></i>
                ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã«ç§»å‹•
            </a>
        </div>
        
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ç§»è¡Œã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿</h2>
            <div id="dataPreview" class="space-y-2"></div>
        </div>
    </div>

    <script>
        // æœ€æ–°ã®ç§»è¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆ2025å¹´1æœˆ22æ—¥ç¾åœ¨ï¼‰
        const migrationData = {
            "subjects": [
                {"id":1,"name":"åœ°ç†ç™½åœ°å›³ï¼ˆ1265èªï¼‰","target_questions":1265,"deadline":"2025-08-16","unit":"ãƒšãƒ¼ã‚¸"},
                {"id":2,"name":"ç™½ãƒãƒ£A","target_questions":113,"deadline":"2025-02-09","unit":"å•"},
                {"id":3,"name":"ç™½ãƒãƒ£â…¡","target_questions":209,"deadline":"2025-01-23","unit":"å•"},
                {"id":4,"name":"ç™½ãƒãƒ£B","target_questions":60,"deadline":"2025-02-09","unit":"å•"},
                {"id":5,"name":"åœ°ç†ç™½åœ°å›³å¾©ç¿’","target_questions":999,"deadline":"2025-03-11","unit":"ãƒšãƒ¼ã‚¸"},
                {"id":6,"name":"ç™½ãƒãƒ£å¾©ç¿’","target_questions":999,"deadline":"2025-03-11","unit":"å•"},
                {"id":7,"name":"ãƒã‚¯ã‚¹ãƒ†æ–‡æ³•å¾©ç¿’","target_questions":9999,"deadline":"2025-03-11","unit":"å•"},
                {"id":8,"name":"ãƒã‚¯ã‚¹ãƒ†èªæ³•","target_questions":228,"deadline":"2025-02-11","unit":"å•"},
                {"id":9,"name":"ãƒã‚¯ã‚¹ãƒ†","target_questions":514,"deadline":"2025-01-09","unit":"å•"},
                {"id":10,"name":"ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900","target_questions":1900,"deadline":"2025-01-09","unit":"å€‹"},
                {"id":11,"name":"åœ°ç†Bä¸€å•ä¸€ç­”â­â­â­","target_questions":1789,"deadline":"2025-01-09","unit":"å•"},
                {"id":12,"name":"ç™½ãƒãƒ£I","target_questions":155,"deadline":"2025-01-09","unit":"å•"},
                {"id":13,"name":"ç™½ãƒãƒ£C","target_questions":66,"deadline":"2025-02-09","unit":"å•"}
            ],
            "dailyProgress": [
                // åœ°ç†ç™½åœ°å›³ï¼ˆ1265èªï¼‰ - åˆè¨ˆ: 850ãƒšãƒ¼ã‚¸
                {"id":1,"subject_id":1,"date":"2024-12-01","completed_count":50},
                {"id":2,"subject_id":1,"date":"2024-12-15","completed_count":100},
                {"id":3,"subject_id":1,"date":"2025-01-01","completed_count":150},
                {"id":4,"subject_id":1,"date":"2025-01-10","completed_count":200},
                {"id":5,"subject_id":1,"date":"2025-01-15","completed_count":150},
                {"id":41,"subject_id":1,"date":"2025-01-18","completed_count":100},
                {"id":42,"subject_id":1,"date":"2025-01-20","completed_count":100},
                
                // ç™½ãƒãƒ£A - åˆè¨ˆ: 113å•ï¼ˆå®Œäº†ï¼‰
                {"id":6,"subject_id":2,"date":"2024-12-10","completed_count":30},
                {"id":7,"subject_id":2,"date":"2024-12-20","completed_count":40},
                {"id":8,"subject_id":2,"date":"2025-01-05","completed_count":43},
                
                // ç™½ãƒãƒ£â…¡ - åˆè¨ˆ: 209å•ï¼ˆå®Œäº†ï¼‰ 
                {"id":9,"subject_id":3,"date":"2024-12-05","completed_count":40},
                {"id":10,"subject_id":3,"date":"2024-12-25","completed_count":60},
                {"id":11,"subject_id":3,"date":"2025-01-08","completed_count":80},
                {"id":43,"subject_id":3,"date":"2025-01-21","completed_count":29},
                
                // ç™½ãƒãƒ£B - åˆè¨ˆ: 60å•ï¼ˆå®Œäº†ï¼‰
                {"id":12,"subject_id":4,"date":"2025-01-10","completed_count":25},
                {"id":13,"subject_id":4,"date":"2025-01-15","completed_count":20},
                {"id":44,"subject_id":4,"date":"2025-01-22","completed_count":15},
                
                // åœ°ç†ç™½åœ°å›³å¾©ç¿’ - åˆè¨ˆ: 350ãƒšãƒ¼ã‚¸
                {"id":14,"subject_id":5,"date":"2025-01-12","completed_count":100},
                {"id":15,"subject_id":5,"date":"2025-01-14","completed_count":100},
                {"id":45,"subject_id":5,"date":"2025-01-19","completed_count":75},
                {"id":46,"subject_id":5,"date":"2025-01-21","completed_count":75},
                
                // ç™½ãƒãƒ£å¾©ç¿’ - åˆè¨ˆ: 280å•
                {"id":16,"subject_id":6,"date":"2025-01-11","completed_count":75},
                {"id":17,"subject_id":6,"date":"2025-01-13","completed_count":75},
                {"id":47,"subject_id":6,"date":"2025-01-17","completed_count":65},
                {"id":48,"subject_id":6,"date":"2025-01-20","completed_count":65},
                
                // ãƒã‚¯ã‚¹ãƒ†æ–‡æ³•å¾©ç¿’ - åˆè¨ˆ: 850å•
                {"id":18,"subject_id":7,"date":"2025-01-05","completed_count":200},
                {"id":19,"subject_id":7,"date":"2025-01-10","completed_count":300},
                {"id":49,"subject_id":7,"date":"2025-01-16","completed_count":175},
                {"id":50,"subject_id":7,"date":"2025-01-21","completed_count":175},
                
                // ãƒã‚¯ã‚¹ãƒ†èªæ³• - åˆè¨ˆ: 228å•ï¼ˆå®Œäº†ï¼‰
                {"id":20,"subject_id":8,"date":"2024-12-28","completed_count":50},
                {"id":21,"subject_id":8,"date":"2025-01-07","completed_count":50},
                {"id":22,"subject_id":8,"date":"2025-01-14","completed_count":50},
                {"id":51,"subject_id":8,"date":"2025-01-19","completed_count":40},
                {"id":52,"subject_id":8,"date":"2025-01-22","completed_count":38},
                
                // ãƒã‚¯ã‚¹ãƒ† - åˆè¨ˆ: 514å•ï¼ˆå®Œäº†ï¼‰
                {"id":23,"subject_id":9,"date":"2024-11-20","completed_count":100},
                {"id":24,"subject_id":9,"date":"2024-12-01","completed_count":150},
                {"id":25,"subject_id":9,"date":"2024-12-15","completed_count":150},
                {"id":26,"subject_id":9,"date":"2025-01-03","completed_count":114},
                
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1900 - åˆè¨ˆ: 1900å€‹ï¼ˆå®Œäº†ï¼‰
                {"id":27,"subject_id":10,"date":"2024-11-01","completed_count":300},
                {"id":28,"subject_id":10,"date":"2024-11-15","completed_count":400},
                {"id":29,"subject_id":10,"date":"2024-12-01","completed_count":400},
                {"id":30,"subject_id":10,"date":"2024-12-15","completed_count":400},
                {"id":31,"subject_id":10,"date":"2025-01-01","completed_count":400},
                
                // åœ°ç†Bä¸€å•ä¸€ç­” - åˆè¨ˆ: 1500å•
                {"id":32,"subject_id":11,"date":"2024-12-01","completed_count":200},
                {"id":33,"subject_id":11,"date":"2024-12-10","completed_count":300},
                {"id":34,"subject_id":11,"date":"2024-12-20","completed_count":300},
                {"id":35,"subject_id":11,"date":"2025-01-05","completed_count":400},
                {"id":53,"subject_id":11,"date":"2025-01-18","completed_count":150},
                {"id":54,"subject_id":11,"date":"2025-01-22","completed_count":150},
                
                // ç™½ãƒãƒ£I - åˆè¨ˆ: 155å•ï¼ˆå®Œäº†ï¼‰
                {"id":36,"subject_id":12,"date":"2024-12-08","completed_count":55},
                {"id":37,"subject_id":12,"date":"2024-12-18","completed_count":50},
                {"id":38,"subject_id":12,"date":"2025-01-02","completed_count":50},
                
                // ç™½ãƒãƒ£C - åˆè¨ˆ: 55å•
                {"id":39,"subject_id":13,"date":"2025-01-12","completed_count":20},
                {"id":40,"subject_id":13,"date":"2025-01-14","completed_count":20},
                {"id":55,"subject_id":13,"date":"2025-01-21","completed_count":15}
            ]
        };

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            showDataPreview();
        });

        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            
            // å„ç§‘ç›®ã®é”æˆæ•°ã‚’è¨ˆç®—
            const subjectProgress = {};
            migrationData.dailyProgress.forEach(p => {
                if (!subjectProgress[p.subject_id]) {
                    subjectProgress[p.subject_id] = 0;
                }
                subjectProgress[p.subject_id] += p.completed_count;
            });
            
            const totalProgress = Object.values(subjectProgress).reduce((sum, val) => sum + val, 0);
            
            preview.innerHTML = `
                <div class="p-3 bg-gray-50 rounded">
                    <p><strong>ç§‘ç›®æ•°:</strong> ${migrationData.subjects.length}ç§‘ç›®</p>
                    <p><strong>é€²æ—è¨˜éŒ²æ•°:</strong> ${migrationData.dailyProgress.length}ä»¶</p>
                    <p><strong>ç·é€²æ—:</strong> ${totalProgress.toLocaleString()}å•/ãƒšãƒ¼ã‚¸/å€‹</p>
                </div>
                <div class="mt-4">
                    <h3 class="font-semibold mb-3 text-lg">ç§‘ç›®åˆ¥é€²æ—çŠ¶æ³:</h3>
                    <div class="space-y-2">
                        ${migrationData.subjects.map(s => {
                            const completed = subjectProgress[s.id] || 0;
                            const percentage = Math.min(100, Math.round((completed / s.target_questions) * 100));
                            const isComplete = completed >= s.target_questions;
                            const statusColor = isComplete ? 'text-green-600' : percentage >= 50 ? 'text-blue-600' : 'text-gray-600';
                            const statusEmoji = isComplete ? 'âœ…' : percentage >= 50 ? 'ğŸ“‹' : 'ğŸ“';
                            
                            return `
                                <div class="p-3 bg-white border rounded-lg">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium">${statusEmoji} ${s.name}</span>
                                        <span class="text-sm text-gray-500">æœŸé™: ${s.deadline}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="${statusColor} font-bold">
                                            ${completed.toLocaleString()} / ${s.target_questions.toLocaleString()}${s.unit}
                                        </span>
                                        <span class="${statusColor} font-bold">
                                            ${percentage}%
                                        </span>
                                    </div>
                                    <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                                        <div class="${isComplete ? 'bg-green-500' : 'bg-blue-500'} h-2 rounded-full" 
                                             style="width: ${Math.min(100, percentage)}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function migrateData() {
            const statusDiv = document.getElementById('statusMessage');
            
            console.log('ãƒ‡ãƒ¼ã‚¿ç§»è¡Œé–‹å§‹...');
            console.log('ç§»è¡Œã™ã‚‹ç§‘ç›®æ•°:', migrationData.subjects.length);
            console.log('ç§»è¡Œã™ã‚‹é€²æ—è¨˜éŒ²æ•°:', migrationData.dailyProgress.length);
            
            try {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                const existingSubjects = localStorage.getItem('studySubjects');
                const existingProgress = localStorage.getItem('studyProgress');
                
                if (existingSubjects || existingProgress) {
                    const backup = {
                        subjects: existingSubjects ? JSON.parse(existingSubjects) : [],
                        progress: existingProgress ? JSON.parse(existingProgress) : [],
                        backupDate: new Date().toISOString()
                    };
                    localStorage.setItem('studyBackup', JSON.stringify(backup));
                    statusDiv.innerHTML = `
                        <div class="p-3 bg-yellow-100 text-yellow-800 rounded mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ
                        </div>
                    `;
                }
                
                // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã®LocalStorageã‚­ãƒ¼ã«åˆã‚ã›ã‚‹ï¼‰
                localStorage.setItem('studySubjects', JSON.stringify(migrationData.subjects));
                localStorage.setItem('studyProgress', JSON.stringify(migrationData.dailyProgress));
                
                // ä¿å­˜ç¢ºèª
                const savedSubjects = localStorage.getItem('studySubjects');
                const savedProgress = localStorage.getItem('studyProgress');
                
                if (savedSubjects && savedProgress) {
                    const subjects = JSON.parse(savedSubjects);
                    const progress = JSON.parse(savedProgress);
                    console.log('ä¿å­˜æˆåŠŸ - ç§‘ç›®æ•°:', subjects.length);
                    console.log('ä¿å­˜æˆåŠŸ - é€²æ—è¨˜éŒ²æ•°:', progress.length);
                } else {
                    console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                statusDiv.innerHTML += `
                    <div class="p-3 bg-green-100 text-green-800 rounded">
                        <i class="fas fa-check-circle mr-2"></i>
                        ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼<br>
                        ${migrationData.subjects.length}ç§‘ç›®ã€${migrationData.dailyProgress.length}ä»¶ã®é€²æ—è¨˜éŒ²ã‚’ç§»è¡Œã—ã¾ã—ãŸã€‚<br>
                        3ç§’å¾Œã«ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã«ç§»å‹•ã—ã¾ã™...
                    </div>
                `;
                
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                document.getElementById('migrateBtn').disabled = true;
                document.getElementById('migrateBtn').classList.add('opacity-50', 'cursor-not-allowed');
                
                // 3ç§’å¾Œã«è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã«ç§»å‹•
                setTimeout(() => {
                    console.log('ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã«ç§»å‹•ã—ã¾ã™...');
                    window.location.href = './index.html';
                }, 3000);
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="p-3 bg-red-100 text-red-800 rounded">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}
                    </div>
                `;
            }
        }
        
        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰ç§»è¡Œ
        function confirmAndMigrate() {
            const existingSubjects = localStorage.getItem('studySubjects');
            const existingProgress = localStorage.getItem('studyProgress');
            
            if (existingSubjects || existingProgress) {
                let message = 'âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\n';
                
                if (existingSubjects) {
                    try {
                        const subjects = JSON.parse(existingSubjects);
                        message += `ç¾åœ¨ã®ç§‘ç›®æ•°: ${subjects.length}ç§‘ç›®\n`;
                    } catch (e) {
                        console.error(e);
                    }
                }
                
                if (existingProgress) {
                    try {
                        const progress = JSON.parse(existingProgress);
                        message += `ç¾åœ¨ã®é€²æ—è¨˜éŒ²: ${progress.length}ä»¶\n`;
                    } catch (e) {
                        console.error(e);
                    }
                }
                
                message += '\næœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚';
                
                if (confirm(message)) {
                    migrateData();
                }
            } else {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãã®ã¾ã¾å®Ÿè¡Œ
                migrateData();
            }
        }
    </script>
</body>
</html>