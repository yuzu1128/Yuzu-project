<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ移行ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <!-- 重要なお知らせ -->
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
            <p class="font-bold">📢 最新データ移行ツール</p>
            <p class="text-sm mt-1">2025年1月22日時点の最新学習データ（13科目、進捗記録含む）</p>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold mb-4">
                <i class="fas fa-database mr-2"></i>
                データ移行ツール
            </h1>
            
            <div class="mb-6 p-4 bg-blue-50 rounded">
                <h2 class="text-lg font-semibold mb-2">📋 このツールの使い方</h2>
                <ol class="list-decimal list-inside space-y-1">
                    <li>下の「データを自動インポート」ボタンをクリック</li>
                    <li>3秒後にメインアプリに自動移動します</li>
                    <li>データが正しく表示されていることを確認してください</li>
                </ol>
            </div>
            
            <div id="statusMessage" class="mb-4"></div>
            
            <button id="migrateBtn" onclick="confirmAndMigrate()" class="bg-blue-500 text-white px-6 py-3 rounded hover:bg-blue-600 transition text-lg font-medium">
                <i class="fas fa-download mr-2"></i>
                データを自動インポート
            </button>
            
            <a href="./index.html" class="inline-block mt-4 bg-green-500 text-white px-6 py-3 rounded hover:bg-green-600 transition">
                <i class="fas fa-home mr-2"></i>
                メインアプリに移動
            </a>
        </div>
        
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">移行されるデータ</h2>
            <div id="dataPreview" class="space-y-2"></div>
        </div>
    </div>

    <script>
        // 最新の移行データ（2025年1月22日現在）
        const migrationData = {
            "subjects": [
                {"id":1,"name":"地理白地図（1265語）","target_questions":1265,"deadline":"2025-08-16","unit":"ページ"},
                {"id":2,"name":"白チャA","target_questions":113,"deadline":"2025-02-09","unit":"問"},
                {"id":3,"name":"白チャⅡ","target_questions":209,"deadline":"2025-01-23","unit":"問"},
                {"id":4,"name":"白チャB","target_questions":60,"deadline":"2025-02-09","unit":"問"},
                {"id":5,"name":"地理白地図復習","target_questions":999,"deadline":"2025-03-11","unit":"ページ"},
                {"id":6,"name":"白チャ復習","target_questions":999,"deadline":"2025-03-11","unit":"問"},
                {"id":7,"name":"ネクステ文法復習","target_questions":9999,"deadline":"2025-03-11","unit":"問"},
                {"id":8,"name":"ネクステ語法","target_questions":228,"deadline":"2025-02-11","unit":"問"},
                {"id":9,"name":"ネクステ","target_questions":514,"deadline":"2025-01-09","unit":"問"},
                {"id":10,"name":"ターゲット1900","target_questions":1900,"deadline":"2025-01-09","unit":"個"},
                {"id":11,"name":"地理B一問一答⭐⭐⭐","target_questions":1789,"deadline":"2025-01-09","unit":"問"},
                {"id":12,"name":"白チャI","target_questions":155,"deadline":"2025-01-09","unit":"問"},
                {"id":13,"name":"白チャC","target_questions":66,"deadline":"2025-02-09","unit":"問"}
            ],
            "dailyProgress": [
                // 地理白地図（1265語） - 合計: 850ページ
                {"id":1,"subject_id":1,"date":"2024-12-01","completed_count":50},
                {"id":2,"subject_id":1,"date":"2024-12-15","completed_count":100},
                {"id":3,"subject_id":1,"date":"2025-01-01","completed_count":150},
                {"id":4,"subject_id":1,"date":"2025-01-10","completed_count":200},
                {"id":5,"subject_id":1,"date":"2025-01-15","completed_count":150},
                {"id":41,"subject_id":1,"date":"2025-01-18","completed_count":100},
                {"id":42,"subject_id":1,"date":"2025-01-20","completed_count":100},
                
                // 白チャA - 合計: 113問（完了）
                {"id":6,"subject_id":2,"date":"2024-12-10","completed_count":30},
                {"id":7,"subject_id":2,"date":"2024-12-20","completed_count":40},
                {"id":8,"subject_id":2,"date":"2025-01-05","completed_count":43},
                
                // 白チャⅡ - 合計: 209問（完了） 
                {"id":9,"subject_id":3,"date":"2024-12-05","completed_count":40},
                {"id":10,"subject_id":3,"date":"2024-12-25","completed_count":60},
                {"id":11,"subject_id":3,"date":"2025-01-08","completed_count":80},
                {"id":43,"subject_id":3,"date":"2025-01-21","completed_count":29},
                
                // 白チャB - 合計: 60問（完了）
                {"id":12,"subject_id":4,"date":"2025-01-10","completed_count":25},
                {"id":13,"subject_id":4,"date":"2025-01-15","completed_count":20},
                {"id":44,"subject_id":4,"date":"2025-01-22","completed_count":15},
                
                // 地理白地図復習 - 合計: 350ページ
                {"id":14,"subject_id":5,"date":"2025-01-12","completed_count":100},
                {"id":15,"subject_id":5,"date":"2025-01-14","completed_count":100},
                {"id":45,"subject_id":5,"date":"2025-01-19","completed_count":75},
                {"id":46,"subject_id":5,"date":"2025-01-21","completed_count":75},
                
                // 白チャ復習 - 合計: 280問
                {"id":16,"subject_id":6,"date":"2025-01-11","completed_count":75},
                {"id":17,"subject_id":6,"date":"2025-01-13","completed_count":75},
                {"id":47,"subject_id":6,"date":"2025-01-17","completed_count":65},
                {"id":48,"subject_id":6,"date":"2025-01-20","completed_count":65},
                
                // ネクステ文法復習 - 合計: 850問
                {"id":18,"subject_id":7,"date":"2025-01-05","completed_count":200},
                {"id":19,"subject_id":7,"date":"2025-01-10","completed_count":300},
                {"id":49,"subject_id":7,"date":"2025-01-16","completed_count":175},
                {"id":50,"subject_id":7,"date":"2025-01-21","completed_count":175},
                
                // ネクステ語法 - 合計: 228問（完了）
                {"id":20,"subject_id":8,"date":"2024-12-28","completed_count":50},
                {"id":21,"subject_id":8,"date":"2025-01-07","completed_count":50},
                {"id":22,"subject_id":8,"date":"2025-01-14","completed_count":50},
                {"id":51,"subject_id":8,"date":"2025-01-19","completed_count":40},
                {"id":52,"subject_id":8,"date":"2025-01-22","completed_count":38},
                
                // ネクステ - 合計: 514問（完了）
                {"id":23,"subject_id":9,"date":"2024-11-20","completed_count":100},
                {"id":24,"subject_id":9,"date":"2024-12-01","completed_count":150},
                {"id":25,"subject_id":9,"date":"2024-12-15","completed_count":150},
                {"id":26,"subject_id":9,"date":"2025-01-03","completed_count":114},
                
                // ターゲット1900 - 合計: 1900個（完了）
                {"id":27,"subject_id":10,"date":"2024-11-01","completed_count":300},
                {"id":28,"subject_id":10,"date":"2024-11-15","completed_count":400},
                {"id":29,"subject_id":10,"date":"2024-12-01","completed_count":400},
                {"id":30,"subject_id":10,"date":"2024-12-15","completed_count":400},
                {"id":31,"subject_id":10,"date":"2025-01-01","completed_count":400},
                
                // 地理B一問一答 - 合計: 1500問
                {"id":32,"subject_id":11,"date":"2024-12-01","completed_count":200},
                {"id":33,"subject_id":11,"date":"2024-12-10","completed_count":300},
                {"id":34,"subject_id":11,"date":"2024-12-20","completed_count":300},
                {"id":35,"subject_id":11,"date":"2025-01-05","completed_count":400},
                {"id":53,"subject_id":11,"date":"2025-01-18","completed_count":150},
                {"id":54,"subject_id":11,"date":"2025-01-22","completed_count":150},
                
                // 白チャI - 合計: 155問（完了）
                {"id":36,"subject_id":12,"date":"2024-12-08","completed_count":55},
                {"id":37,"subject_id":12,"date":"2024-12-18","completed_count":50},
                {"id":38,"subject_id":12,"date":"2025-01-02","completed_count":50},
                
                // 白チャC - 合計: 55問
                {"id":39,"subject_id":13,"date":"2025-01-12","completed_count":20},
                {"id":40,"subject_id":13,"date":"2025-01-14","completed_count":20},
                {"id":55,"subject_id":13,"date":"2025-01-21","completed_count":15}
            ]
        };

        // ページロード時にデータプレビューを表示
        document.addEventListener('DOMContentLoaded', function() {
            showDataPreview();
        });

        function showDataPreview() {
            const preview = document.getElementById('dataPreview');
            
            // 各科目の達成数を計算
            const subjectProgress = {};
            migrationData.dailyProgress.forEach(p => {
                if (!subjectProgress[p.subject_id]) {
                    subjectProgress[p.subject_id] = 0;
                }
                subjectProgress[p.subject_id] += p.completed_count;
            });
            
            const totalProgress = Object.values(subjectProgress).reduce((sum, val) => sum + val, 0);
            
            preview.innerHTML = `
                <div class="p-3 bg-gray-50 rounded">
                    <p><strong>科目数:</strong> ${migrationData.subjects.length}科目</p>
                    <p><strong>進捗記録数:</strong> ${migrationData.dailyProgress.length}件</p>
                    <p><strong>総進捗:</strong> ${totalProgress.toLocaleString()}問/ページ/個</p>
                </div>
                <div class="mt-4">
                    <h3 class="font-semibold mb-3 text-lg">科目別進捗状況:</h3>
                    <div class="space-y-2">
                        ${migrationData.subjects.map(s => {
                            const completed = subjectProgress[s.id] || 0;
                            const percentage = Math.min(100, Math.round((completed / s.target_questions) * 100));
                            const isComplete = completed >= s.target_questions;
                            const statusColor = isComplete ? 'text-green-600' : percentage >= 50 ? 'text-blue-600' : 'text-gray-600';
                            const statusEmoji = isComplete ? '✅' : percentage >= 50 ? '📋' : '📝';
                            
                            return `
                                <div class="p-3 bg-white border rounded-lg">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-medium">${statusEmoji} ${s.name}</span>
                                        <span class="text-sm text-gray-500">期限: ${s.deadline}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="${statusColor} font-bold">
                                            ${completed.toLocaleString()} / ${s.target_questions.toLocaleString()}${s.unit}
                                        </span>
                                        <span class="${statusColor} font-bold">
                                            ${percentage}%
                                        </span>
                                    </div>
                                    <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                                        <div class="${isComplete ? 'bg-green-500' : 'bg-blue-500'} h-2 rounded-full" 
                                             style="width: ${Math.min(100, percentage)}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function migrateData() {
            const statusDiv = document.getElementById('statusMessage');
            
            console.log('データ移行開始...');
            console.log('移行する科目数:', migrationData.subjects.length);
            console.log('移行する進捗記録数:', migrationData.dailyProgress.length);
            
            try {
                // 既存データをバックアップ
                const existingSubjects = localStorage.getItem('studySubjects');
                const existingProgress = localStorage.getItem('studyProgress');
                
                if (existingSubjects || existingProgress) {
                    const backup = {
                        subjects: existingSubjects ? JSON.parse(existingSubjects) : [],
                        progress: existingProgress ? JSON.parse(existingProgress) : [],
                        backupDate: new Date().toISOString()
                    };
                    localStorage.setItem('studyBackup', JSON.stringify(backup));
                    statusDiv.innerHTML = `
                        <div class="p-3 bg-yellow-100 text-yellow-800 rounded mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            既存データをバックアップしました
                        </div>
                    `;
                }
                
                // 新しいデータを保存（メインアプリのLocalStorageキーに合わせる）
                localStorage.setItem('studySubjects', JSON.stringify(migrationData.subjects));
                localStorage.setItem('studyProgress', JSON.stringify(migrationData.dailyProgress));
                
                // 保存確認
                const savedSubjects = localStorage.getItem('studySubjects');
                const savedProgress = localStorage.getItem('studyProgress');
                
                if (savedSubjects && savedProgress) {
                    const subjects = JSON.parse(savedSubjects);
                    const progress = JSON.parse(savedProgress);
                    console.log('保存成功 - 科目数:', subjects.length);
                    console.log('保存成功 - 進捗記録数:', progress.length);
                } else {
                    console.error('データ保存に失敗しました');
                }
                
                statusDiv.innerHTML += `
                    <div class="p-3 bg-green-100 text-green-800 rounded">
                        <i class="fas fa-check-circle mr-2"></i>
                        データ移行が完了しました！<br>
                        ${migrationData.subjects.length}科目、${migrationData.dailyProgress.length}件の進捗記録を移行しました。<br>
                        3秒後にメインアプリに移動します...
                    </div>
                `;
                
                // ボタンを無効化
                document.getElementById('migrateBtn').disabled = true;
                document.getElementById('migrateBtn').classList.add('opacity-50', 'cursor-not-allowed');
                
                // 3秒後に自動的にメインアプリに移動
                setTimeout(() => {
                    console.log('メインアプリに移動します...');
                    window.location.href = './index.html';
                }, 3000);
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="p-3 bg-red-100 text-red-800 rounded">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        エラーが発生しました: ${error.message}
                    </div>
                `;
            }
        }
        
        // 確認ダイアログを表示してから移行
        function confirmAndMigrate() {
            const existingSubjects = localStorage.getItem('studySubjects');
            const existingProgress = localStorage.getItem('studyProgress');
            
            if (existingSubjects || existingProgress) {
                let message = '⚠️ 既存データが検出されました。\n\n';
                
                if (existingSubjects) {
                    try {
                        const subjects = JSON.parse(existingSubjects);
                        message += `現在の科目数: ${subjects.length}科目\n`;
                    } catch (e) {
                        console.error(e);
                    }
                }
                
                if (existingProgress) {
                    try {
                        const progress = JSON.parse(existingProgress);
                        message += `現在の進捗記録: ${progress.length}件\n`;
                    } catch (e) {
                        console.error(e);
                    }
                }
                
                message += '\n最新データで上書きしますか？\n※既存データはバックアップされます。';
                
                if (confirm(message)) {
                    migrateData();
                }
            } else {
                // 既存データがない場合はそのまま実行
                migrateData();
            }
        }
    </script>
</body>
</html>